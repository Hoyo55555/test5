<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>國文課：兒時記趣 - 互動闖關大挑戰</title>
    
    <!-- 載入核心庫 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/17.0.2/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/17.0.2/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/6.26.0/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'ink-black': '#2c2c2c',
                        'paper-bg': '#fdfbf7',
                        'tea-brown': '#8d6e63',
                        'accent-gold': '#d4af37',
                        'bamboo-green': '#556b2f',
                        'vermilion': '#e34234',
                    },
                    fontFamily: {
                        serif: ['"Noto Serif TC"', 'serif'],
                    },
                    backgroundImage: {
                        'paper-texture': "url('https://www.transparenttextures.com/patterns/cream-paper.png')",
                    },
                    animation: {
                        'float': 'float 3s ease-in-out infinite',
                        'fadeIn': 'fadeIn 0.5s ease-in',
                    },
                    keyframes: {
                        float: {
                            '0%, 100%': { transform: 'translateY(0)' },
                            '50%': { transform: 'translateY(-5px)' },
                        },
                        fadeIn: {
                            'from': { opacity: '0' },
                            'to': { opacity: '1' },
                        }
                    }
                }
            }
        }
    </script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Serif+TC:wght@400;700&display=swap');
        body { 
            font-family: 'Noto Serif TC', serif; 
            background-color: #fdfbf7; 
            color: #2c2c2c;
            background-image: url('https://www.transparenttextures.com/patterns/cream-paper.png');
        }
        .ink-border {
            border: 2px solid #2c2c2c;
            border-radius: 8px;
            box-shadow: 4px 4px 0px #8d6e63;
        }
        .btn-classical {
            background-color: #8d6e63;
            color: white;
            padding: 0.5rem 1.5rem;
            border-radius: 9999px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            cursor: pointer;
            user-select: none;
        }
        .btn-classical:hover:not(:disabled) {
            background-color: #5d4037;
            transform: translateY(-2px);
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .btn-classical:disabled {
            background-color: #d1d5db;
            cursor: not-allowed;
            transform: none;
        }
        /* 隱藏檔案上傳 input */
        input[type="file"] {
            display: none;
        }
    </style>
</head>
<body>
    <div id="root" class="min-h-screen flex items-center justify-center">
        <div class="text-center text-gray-500 animate-pulse">
            <h2 class="text-2xl mb-2">正在佈置書房...</h2>
            <p>請稍候片刻</p>
        </div>
    </div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // ==========================================
        //  設定區域：請在此替換您的圖片連結
        // ==========================================
        const TEACHER_CONFIG = {
            // 設定 1：NPC 老夫子圖片路徑
            npcImage: "image/老夫子.jpg", 

            // 設定 2：沈復圖片路徑
            shenFuImage: "image/沈復陳芸.jpeg"
        };
        // ==========================================

        // --- 圖示元件 ---
        const Icon = ({ name, size = 24, className = "" }) => {
            return <i data-lucide={name} style={{ width: size, height: size }} className={className}></i>;
        };

        // --- 音效系統 ---
        let audioCtx = null;
        const playSound = (type) => {
            try {
                if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                if (audioCtx.state === 'suspended') audioCtx.resume();
                
                const osc = audioCtx.createOscillator();
                const gainNode = audioCtx.createGain();
                osc.connect(gainNode);
                gainNode.connect(audioCtx.destination);
                
                const now = audioCtx.currentTime;
                
                if (type === 'click') {
                    osc.type = 'sine';
                    osc.frequency.setValueAtTime(600, now);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.exponentialRampToValueAtTime(0.01, now + 0.1);
                    osc.start(now);
                    osc.stop(now + 0.1);
                } else if (type === 'correct') {
                    osc.type = 'triangle';
                    osc.frequency.setValueAtTime(440, now);
                    osc.frequency.linearRampToValueAtTime(554, now + 0.1);
                    osc.frequency.linearRampToValueAtTime(659, now + 0.2);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.4);
                    osc.start(now);
                    osc.stop(now + 0.4);
                } else if (type === 'wrong') {
                    osc.type = 'sawtooth';
                    osc.frequency.setValueAtTime(150, now);
                    osc.frequency.linearRampToValueAtTime(100, now + 0.3);
                    gainNode.gain.setValueAtTime(0.05, now);
                    gainNode.gain.linearRampToValueAtTime(0, now + 0.3);
                    osc.start(now);
                    osc.stop(now + 0.3);
                }
            } catch(e) {
                console.log("Audio play failed", e);
            }
        };

        // --- 資料庫 (修正版) ---
        const POOL_LEVEL1 = [
            { char: '藐', pinyin: 'ㄇㄧㄠˇ', mean: '微小', desc: '藐小微物' },
            { char: '壑', pinyin: 'ㄏㄨㄛˋ', mean: '山谷', desc: '凹者為壑' }, 
            { char: '龐', pinyin: 'ㄆㄤˊ', mean: '巨大', desc: '龐然大物' },
            { char: '礫', pinyin: 'ㄌㄧˋ', mean: '小石子', desc: '土礫' },
            { char: '擬', pinyin: 'ㄋㄧˇ', mean: '比擬', desc: '私擬作' },
            { char: '強', pinyin: 'ㄐㄧㄤˋ', mean: '僵硬', desc: '項為之強' }, 
            { char: '唳', pinyin: 'ㄌㄧˋ', mean: '鳥鳴', desc: '鶴唳雲端' },
            { char: '怡', pinyin: 'ㄧˊ', mean: '喜悅', desc: '怡然稱快' },
            { char: '稚', pinyin: 'ㄓˋ', mean: '幼小', desc: '童稚' },
            { char: '昂', pinyin: 'ㄤˊ', mean: '抬頭', desc: '昂首觀之' },
            { char: '素', pinyin: 'ㄙㄨˋ', mean: '白色', desc: '素帳' },
            { char: '驅', pinyin: 'ㄑㄩ', mean: '趕走', desc: '驅之別院' },
            { char: '察', pinyin: 'ㄔㄚˊ', mean: '觀察', desc: '明察秋毫' },
            { char: '叢', pinyin: 'ㄘㄨㄥˊ', mean: '繁雜', desc: '叢草' },
            { char: '凹', pinyin: 'ㄠ', mean: '低陷', desc: '凹者為壑' },
            { char: '凸', pinyin: 'ㄊㄨˊ', mean: '高起', desc: '凸者為丘' }, // 修正注音
            { char: '憶', pinyin: 'ㄧˋ', mean: '回想', desc: '余憶童稚時' },
            { char: '毫', pinyin: 'ㄏㄠˊ', mean: '細毛', desc: '秋毫' }
            // 已刪除：癩、雷
        ];

        const POOL_LEVEL2 = [
            { text: '項「為」之強', word: '為', ans: '因為', options: ['被', '因為', '做'], hint: '這裡是說明原因。' },
            { text: '二蟲盡「為」所吞', word: '為', ans: '被', options: ['被', '因為', '做'], hint: '表示被動。' },
            { text: '昂首觀「之」', word: '之', ans: '它(指蚊子)', options: ['它(指蚊子)', '的', '往'], hint: '代詞，指前面提到的蚊子。' },
            { text: '以叢草「為」林', word: '為', ans: '當作', options: ['被', '當作', '因為'], hint: '把草當成林。' },
            { text: '物外「之」趣', word: '之', ans: '的', options: ['它', '的', '往'], hint: '助詞，無義或解釋為「的」。' },
            { text: '徐噴「以」煙', word: '以', ans: '用', options: ['用', '因為', '把'], hint: '用煙慢慢噴。' },
            { text: '「以」叢草為林', word: '以', ans: '把', options: ['用', '因為', '把'], hint: '把叢草當作林。' },
            { text: '作青雲白鶴「觀」', word: '觀', ans: '景象/看法', options: ['看', '景象/看法', '樓台'], hint: '名詞，指景象。' },
            { text: '昂首「觀」之', word: '觀', ans: '看', options: ['看', '景象', '樓台'], hint: '動詞，抬頭看。' },
            { text: '驅「之」別院', word: '之', ans: '它(指蝦蟆)', options: ['它(指蝦蟆)', '的', '往'], hint: '代詞，指蝦蟆。' },
            { text: '心「之」所向', word: '之', ans: '無義(助詞)', options: ['想像', '往', '無義(助詞)'], hint: '助詞，調整音節，無實義。' },
            { text: '項為「之」強', word: '之', ans: '這件事', options: ['它', '的', '這件事'], hint: '代詞，指「抬頭看蚊子」這件事。' },
            { text: '「蓋」一癩蝦蟆也', word: '蓋', ans: '原來是', options: ['覆蓋', '原來是', '大概'], hint: '承接上文，表示推測或解釋。' },
            { text: '「方」出神', word: '方', ans: '正當', options: ['方向', '正當', '方形'], hint: '表示時間點，正當那時候。' },
            { text: '明察秋「毫」', word: '毫', ans: '細毛', options: ['毛筆', '細毛', '絲毫'], hint: '原指秋天新生的細毛。' },
            { text: '「藐」小微物', word: '藐', ans: '細小', options: ['輕視', '細小', '遙遠'], hint: '形容微小。' },
            { text: '「私」擬作', word: '私', ans: '私下', options: ['自私', '私下', '祕密'], hint: '自己私底下比擬。' },
            { text: '果如鶴「唳」雲端', word: '唳', ans: '鳥鳴', options: ['哭泣', '鳥鳴', '高飛'], hint: '鳥類高聲鳴叫。' },
            { text: '「怡然」稱快', word: '怡然', ans: '喜悅的樣子', options: ['驚訝的樣子', '喜悅的樣子', '生氣的樣子'], hint: '心情愉快的樣子。' },
            { text: '「鞭」數十', word: '鞭', ans: '鞭打', options: ['鞭子', '鞭打', '刑罰'], hint: '名詞轉動詞，用鞭子打。' }
        ];

        const POOL_LEVEL4 = [
            { q: '「明察秋毫」的「秋毫」原意是指什麼？', options: ['秋天的毫毛', '鳥獸在秋天新生的細毛', '秋天的稻穗', '極細微的灰塵'], ans: 1, hint: '毫是指毛髮。' },
            { q: '作者將「夏蚊」想像成「群鶴舞空」，主要是運用了哪兩種能力？', options: ['觀察力與想像力', '記憶力與聯想力', '判斷力與執行力', '觀察力與聽力'], ans: 0, hint: '看與想。' },
            { q: '「項為之強」的「強」字讀音與意思為何？', options: ['ㄑㄧㄤˊ，強壯', 'ㄐㄧㄤˋ，固執', 'ㄐㄧㄤˋ，僵硬', 'ㄑㄧㄤˇ，勉強'], ans: 2, hint: '通「僵」。' },
            { q: '「龐然大物，拔山倒樹而來」，這個「龐然大物」其實是什麼？', options: ['大象', '癩蝦蟆', '野獸', '巨石'], ans: 1, hint: '文中說是癩蝦蟆。' },
            { q: '「徐噴以煙」的「徐」字意思是什麼？', options: ['快速地', '慢慢地', '大力地', '姓徐'], ans: 1, hint: '緩慢的意思。' },
            { q: '關於「之」字的解釋，何者錯誤？', options: ['物外「之」趣：的', '昂首觀「之」：它', '心「之」所向：往', '驅「之」別院：它'], ans: 2, hint: '心之所向的「之」是助詞，「向」才是往。' },
            { q: '下列何者不是作者提到的「物外之趣」？', options: ['觀蚊如鶴', '神遊山林', '鞭打蝦蟆', '捉魚玩水'], ans: 3, hint: '課文無玩水情節。' },
            { q: '「以叢草為林」使用了哪種修辭技巧？', options: ['誇飾', '譬喻', '轉化', '映襯'], ans: 1, hint: '把草比作林。' },
            { q: '作者鞭打蝦蟆，顯示了什麼樣的心情？', options: ['殘忍好殺', '同情弱小、正義感', '無聊打發時間', '研究生物'], ans: 1, hint: '為二蟲抱不平。' },
            { q: '「鶴唳雲端」的「唳」意思是什麼？', options: ['哭泣', '高飛', '鳥類高聲鳴叫', '甚至'], ans: 2, hint: '指鳥鳴。' },
            { q: '「神遊其中，怡然自得」的「神遊」意思是？', options: ['精神疲憊', '心神遊歷', '神仙保佑', '夢遊'], ans: 1, hint: '身體未到，心神已到。' },
            { q: '「二蟲盡為所吞」的「盡」意思是？', options: ['盡力', '全部', '死亡', '盡頭'], ans: 1, hint: '兩隻蟲都被吃了。' },
            { q: '「蓋一癩蝦蟆也」的「蓋」字在此作何解？', options: ['原來是', '覆蓋', '大概', '因為'], ans: 0, hint: '表示恍然大悟。' },
            { q: '「夏蚊成雷」使用了什麼修辭？', options: ['譬喻', '誇飾', '擬人', '轉化'], ans: 1, hint: '聲音像雷一樣大，這是誇大。' },
            { q: '沈復兒時記趣選自哪一本書？', options: ['浮生六記', '世說新語', '聊齋志異', '幽夢影'], ans: 0, hint: '沈復的自傳體散文。' },
            { q: '「拔山倒樹」是用來形容什麼？', options: ['颱風', '癩蝦蟆的聲勢', '地震', '巨人的力量'], ans: 1, hint: '形容龐然大物來襲的氣勢。' },
            { q: '作者用煙燻蚊子的目的是？', options: ['殺死蚊子', '驅趕蚊子', '製造雲霧效果', '無聊好玩'], ans: 2, hint: '作青雲白鶴觀。' },
            { q: '「必細察其紋理」表現出作者具備什麼能力？', options: ['觀察力', '想像力', '記憶力', '判斷力'], ans: 0, hint: '仔細察看。' },
            { q: '「餘憶童稚時」的「童稚」是指？', options: ['幼稚園', '童年', '兒童', '稚氣'], ans: 1, hint: '指小時候。' },
            { q: '下列哪個詞語不是形容「視力好」？', options: ['明察秋毫', '張目對日', '老眼昏花', '細察紋理'], ans: 2, hint: '老眼昏花是看不清楚。' }
        ];

        // --- 工具函數 ---
        const getRandomItems = (pool, count) => {
            const shuffled = [...pool].sort(() => 0.5 - Math.random());
            return shuffled.slice(0, count);
        };

        // --- 結算視窗組件 ---
        const LevelResultModal = ({ title, score, wrongList, onConfirm }) => (
            <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate-fadeIn p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-2xl w-full border-4 border-tea-brown p-6 relative max-h-[90vh] overflow-y-auto">
                    <div className="text-center mb-6">
                        <div className={`w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-2 text-white text-2xl font-bold ${score >= 80 ? 'bg-vermilion' : 'bg-gray-500'}`}>
                            {score}
                        </div>
                        <h3 className="text-2xl font-bold text-ink-black">{title} - 成績單</h3>
                    </div>
                    
                    <div className="bg-stone-50 p-4 rounded-lg text-sm text-gray-700 mb-6 border border-stone-200">
                        <h4 className="font-bold mb-2 text-lg">【錯題回顧與詳解】</h4>
                        {wrongList && wrongList.length > 0 ? (
                            <ul className="space-y-4 text-left">
                                {wrongList.map((item, idx) => (
                                    <li key={idx} className="bg-white p-3 rounded border border-red-200">
                                        <p className="font-bold text-ink-black mb-1">題目：{item.q}</p>
                                        <p className="text-red-600">你的答案：{item.userAns}</p>
                                        <p className="text-green-700 font-bold">正確答案：{item.correctAns}</p>
                                        <p className="text-gray-500 text-xs mt-1">解析：{item.hint || item.desc || "無"}</p>
                                    </li>
                                ))}
                            </ul>
                        ) : (
                            <p className="text-center text-green-600 font-bold text-lg">太厲害了！全對！</p>
                        )}
                    </div>

                    <button onClick={onConfirm} className="w-full btn-classical py-3 text-lg">
                        確認 <Icon name="check" size={20} />
                    </button>
                </div>
            </div>
        );

        // --- 遊戲規則 Modal ---
        const RulesModal = ({ onConfirm }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-50 animate-fadeIn p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-lg w-full border-4 border-tea-brown p-8 relative">
                    <h2 className="text-2xl font-bold text-center mt-2 mb-6 text-ink-black tracking-widest border-b-2 border-dashed border-gray-300 pb-4">私塾學規</h2>
                    <div className="space-y-4 text-gray-700 text-lg leading-relaxed">
                        <div className="flex gap-3"><span className="text-vermilion font-bold">壹、</span><p>需先通過前三關，平均 <span className="font-bold text-vermilion">80分</span> 以上，方可解鎖「最終挑戰」。</p></div>
                        <div className="flex gap-3"><span className="text-vermilion font-bold">貳、</span><p>進入關卡後若「放棄挑戰」，該關卡將被記過，下次完成時<span className="font-bold text-vermilion">扣 10 分</span>。</p></div>
                        <div className="flex gap-3"><span className="text-vermilion font-bold">參、</span><p>第三關為默寫挑戰，請準備好你的鍵盤。</p></div>
                    </div>
                    <button onClick={onConfirm} className="w-full btn-classical py-3 text-xl mt-8 bg-bamboo-green hover:bg-green-700 shadow-md">學生知悉 <Icon name="check" size={24} /></button>
                </div>
            </div>
        );

        // --- 放棄確認 Modal ---
        const AbandonModal = ({ onConfirm, onCancel }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] animate-fadeIn p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full border-4 border-red-800 p-6 text-center">
                    <Icon name="alert-triangle" size={48} className="text-red-600 mx-auto mb-4" />
                    <h3 className="text-2xl font-bold text-red-800 mb-2">確定要放棄？</h3>
                    <p className="text-gray-700 mb-6">現在放棄，挑戰進度將會遺失。<br/>且下次挑戰此關卡將<span className="font-bold text-red-600">先扣 10 分</span>！</p>
                    <div className="flex gap-4">
                        <button onClick={onCancel} className="flex-1 py-2 border-2 border-stone-300 rounded-lg text-stone-600 font-bold hover:bg-stone-100">取消</button>
                        <button onClick={onConfirm} className="flex-1 py-2 bg-red-600 text-white rounded-lg font-bold hover:bg-red-700 shadow">確定放棄</button>
                    </div>
                </div>
            </div>
        );

        // --- 懲罰提示 Modal ---
        const PenaltyNotice = ({ onConfirm }) => (
            <div className="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-[60] animate-fadeIn p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-sm w-full border-4 border-orange-500 p-6 text-center">
                    <Icon name="alert-circle" size={48} className="text-orange-500 mx-auto mb-4" />
                    <h3 className="text-2xl font-bold text-orange-800 mb-2">懲罰生效</h3>
                    <p className="text-gray-700 mb-6">因上次放棄挑戰，<br/>本次結算成績將<span className="font-bold text-red-600">扣除 10 分</span>。</p>
                    <button onClick={onConfirm} className="w-full py-2 bg-orange-500 text-white rounded-lg font-bold hover:bg-orange-600 shadow">開始挑戰</button>
                </div>
            </div>
        );

        // --- 個人資訊確認 Modal ---
        const ProfileConfirmModal = ({ user, setUser, onConfirm }) => (
            <div className="fixed inset-0 bg-black bg-opacity-60 flex items-center justify-center z-[70] animate-fadeIn p-4">
                <div className="bg-white rounded-xl shadow-2xl max-w-md w-full border-4 border-tea-brown p-8">
                    <h2 className="text-2xl font-bold text-center mb-6 text-ink-black border-b pb-2">名帖確認</h2>
                    <p className="text-center text-gray-600 mb-4">即將公佈榜單，請確認您的資料無誤。</p>
                    
                    <div className="space-y-4 mb-6">
                         <div>
                            <label className="text-xs text-gray-500 font-bold">班級</label>
                            <input type="text" value={user.classNo} onChange={e => setUser({...user, classNo: e.target.value})} className="w-full p-2 border border-stone-300 rounded focus:border-tea-brown outline-none" />
                         </div>
                         <div>
                            <label className="text-xs text-gray-500 font-bold">座號</label>
                            <input type="text" value={user.seatNo} onChange={e => setUser({...user, seatNo: e.target.value})} className="w-full p-2 border border-stone-300 rounded focus:border-tea-brown outline-none" />
                         </div>
                         <div>
                            <label className="text-xs text-gray-500 font-bold">姓名</label>
                            <input type="text" value={user.name} onChange={e => setUser({...user, name: e.target.value})} className="w-full p-2 border border-stone-300 rounded focus:border-tea-brown outline-none" />
                         </div>
                    </div>

                    <button onClick={onConfirm} className="w-full btn-classical py-3 text-lg bg-bamboo-green hover:bg-green-700">
                        確認無誤，查看榜單 <Icon name="check" size={20} />
                    </button>
                </div>
            </div>
        );

        // --- 關卡 1: 形音義 (修正：鎖定機制 + 防錯) ---
        const Level1_Words = ({ onFinish, onAbandon, hasPenalty }) => {
            const [questions, setQuestions] = useState([]);
            const [idx, setIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [showPenalty, setShowPenalty] = useState(hasPenalty);
            const [isLocked, setIsLocked] = useState(false); // 鎖定狀態
            
            useEffect(() => {
                const items = getRandomItems(POOL_LEVEL1, 5);
                setQuestions(items);
            }, []);

            if (showPenalty) {
                return <PenaltyNotice onConfirm={() => setShowPenalty(false)} />;
            }
            
            // 安全性檢查：確保題目已載入
            if (!questions || questions.length === 0) return <div className="p-8 text-center text-gray-500">載入考卷中...</div>;

            const currentItem = questions[idx];
            // 防止 currentItem 為空 (雖然有 length 檢查，但雙重保險)
            if (!currentItem) return <div className="p-8 text-center text-gray-500">題目載入錯誤，請重新整理</div>;

            const options = (() => {
                const wrong = POOL_LEVEL1.filter(i => i.mean !== currentItem.mean).sort(() => 0.5 - Math.random()).slice(0, 3).map(i => i.mean);
                return [...wrong, currentItem.mean].sort(() => 0.5 - Math.random());
            })();

            const handleSelect = (meaning) => {
                if (isLocked) return; // 鎖定中，不執行
                setIsLocked(true); // 鎖定

                const currentQ = questions[idx];
                const isCorrect = currentQ.mean === meaning;
                
                const record = {
                    q: `${currentQ.char} (${currentQ.pinyin})`,
                    userAns: meaning,
                    correctAns: currentQ.mean,
                    isCorrect: isCorrect,
                    desc: currentQ.desc
                };

                const newUserAnswers = [...userAnswers, record];
                setUserAnswers(newUserAnswers);

                if (isCorrect) playSound('correct');
                else playSound('wrong');

                if (idx + 1 < questions.length) {
                    setTimeout(() => {
                        setIdx(idx + 1);
                        setIsLocked(false); // 解鎖
                    }, 500);
                } else {
                    setTimeout(() => {
                        finishGame(newUserAnswers);
                    }, 500);
                }
            };

            const finishGame = (answers) => {
                const correctCount = answers.filter(a => a.isCorrect).length;
                const score = (correctCount / answers.length) * 100;
                const wrongList = answers.filter(a => !a.isCorrect);
                onFinish(score, wrongList);
            };

            return (
                <div className="p-6 relative h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4 border-b border-tea-brown pb-2">
                        <h3 className="text-xl font-bold text-tea-brown flex items-center gap-2">
                            <Icon name="feather" /> 第一關：形音義 ({idx + 1}/5)
                        </h3>
                        <button onClick={onAbandon} className="bg-white border border-red-200 px-3 py-1 rounded-full text-red-500 hover:bg-red-500 hover:text-white transition text-sm font-bold flex items-center gap-1 cursor-pointer shadow-sm">
                            <Icon name="log-out" size={14}/> 放棄
                        </button>
                    </div>
                    
                    <div className="text-center mt-4 mb-8 flex-1 flex flex-col justify-center">
                        <div className="inline-block p-8 border-4 border-double border-stone-300 rounded-xl bg-white shadow-lg mx-auto">
                            <h2 className="text-6xl font-serif font-bold text-ink-black mb-2">{currentItem.char}</h2>
                            <p className="text-xl text-gray-500">{currentItem.pinyin}</p>
                        </div>
                    </div>
                    <div className="grid grid-cols-2 gap-4">
                        {options.map((opt, i) => (
                            <button 
                                key={i} 
                                onClick={() => handleSelect(opt)} 
                                disabled={isLocked}
                                className={`p-4 rounded text-xl font-bold transition border shadow-sm ${isLocked ? 'bg-gray-100 cursor-not-allowed opacity-70' : 'bg-stone-100 hover:bg-tea-brown hover:text-white border-stone-200'}`}
                            >
                                {opt}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 關卡 2: 字義偵探 (修正：鎖定機制) ---
        const Level2_Investigator = ({ onFinish, onAbandon, hasPenalty }) => {
            const [questions, setQuestions] = useState([]);
            const [idx, setIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [showPenalty, setShowPenalty] = useState(hasPenalty);
            const [isLocked, setIsLocked] = useState(false);

            useEffect(() => {
                setQuestions(getRandomItems(POOL_LEVEL2, 10));
            }, []);

            if (showPenalty) {
                return <PenaltyNotice onConfirm={() => setShowPenalty(false)} />;
            }
            
            if (!questions || questions.length === 0) return <div className="p-8 text-center text-gray-500">載入考卷中...</div>;

            const handleAns = (opt) => {
                if (isLocked) return;
                setIsLocked(true);

                const q = questions[idx];
                const isCorrect = opt === q.ans;
                const record = { q: q.text, userAns: opt, correctAns: q.ans, isCorrect, hint: q.hint };
                const newAns = [...userAnswers, record];
                setUserAnswers(newAns);
                
                if (isCorrect) playSound('correct');
                else playSound('wrong');

                if (idx + 1 < questions.length) {
                    setTimeout(() => {
                        setIdx(idx + 1);
                        setIsLocked(false);
                    }, 500);
                } else {
                    setTimeout(() => {
                        const correctCount = newAns.filter(a => a.isCorrect).length;
                        const score = (correctCount / 10) * 100;
                        onFinish(score, newAns.filter(a => !a.isCorrect));
                    }, 500);
                }
            };

            const q = questions[idx];
            if (!q) return <div className="p-8 text-center text-gray-500">題目載入錯誤</div>;

            return (
                <div className="p-6 relative h-full flex flex-col">
                     <div className="flex justify-between items-center mb-4 border-b border-tea-brown pb-2">
                        <h3 className="text-xl font-bold text-tea-brown flex items-center gap-2">
                            <Icon name="search" /> 第二關：字義偵探 ({idx + 1}/10)
                        </h3>
                        <button onClick={onAbandon} className="bg-white border border-red-200 px-3 py-1 rounded-full text-red-500 hover:bg-red-500 hover:text-white transition text-sm font-bold flex items-center gap-1 cursor-pointer shadow-sm">
                            <Icon name="log-out" size={14}/> 放棄
                        </button>
                    </div>

                    <div className="bg-white p-8 rounded-lg shadow-md mb-6 text-center border-2 border-stone-100 flex-1 flex flex-col justify-center">
                        <p className="text-3xl font-serif mb-6 text-ink-black font-bold">{q.text}</p>
                        <p className="text-gray-600 mb-6 text-lg">請問「{q.word}」在此處的意思是？</p>
                        <div className="flex flex-wrap justify-center gap-4">
                            {q.options.map((opt, i) => (
                                <button 
                                    key={i} 
                                    onClick={() => handleAns(opt)} 
                                    disabled={isLocked}
                                    className={`px-6 py-3 rounded-full transition shadow-lg text-lg ${isLocked ? 'bg-gray-300 cursor-not-allowed text-white' : 'bg-bamboo-green text-white hover:bg-green-700'}`}
                                >
                                    {opt}
                                </button>
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        // --- 關卡 3: 課文打字 ---
        const Level3_Typing = ({ onFinish, onAbandon, hasPenalty }) => {
            const targetText = "夏蚊成雷，私擬作群鶴舞空，心之所向，則或千或百，果然鶴也。昂首觀之，項為之強。又留蚊於素帳中，徐噴以煙，使之沖煙飛鳴，作青雲白鶴觀，果如鶴唳雲端，為之怡然稱快。";
            const [input, setInput] = useState("");
            const [timeLeft, setTimeLeft] = useState(300);
            const [isFinished, setIsFinished] = useState(false);
            const [showPenalty, setShowPenalty] = useState(hasPenalty);

            useEffect(() => {
                if (timeLeft > 0 && !isFinished && !showPenalty) {
                    const timer = setTimeout(() => setTimeLeft(t => t - 1), 1000);
                    return () => clearTimeout(timer);
                } else if (timeLeft === 0 && !isFinished && !showPenalty) {
                    handleSubmit();
                }
            }, [timeLeft, isFinished, showPenalty]);

            if (showPenalty) {
                return <PenaltyNotice onConfirm={() => setShowPenalty(false)} />;
            }

            const handleSubmit = () => {
                setIsFinished(true);
                let correctChars = 0;
                for(let i=0; i<targetText.length; i++) {
                    if (input[i] === targetText[i]) correctChars++;
                }
                const accuracy = Math.round((correctChars / targetText.length) * 100);
                const lengthPenalty = Math.abs(targetText.length - input.length) > 10 ? 10 : 0;
                const finalScore = Math.max(0, accuracy - lengthPenalty);
                
                const wrongList = finalScore < 100 ? [{q: "課文打字", userAns: "有錯漏字", correctAns: "需完全正確", hint: "請對照課文檢查錯別字與標點符號。"}] : [];
                
                playSound('correct');
                onFinish(finalScore, wrongList);
            };

            return (
                <div className="p-6 relative h-full flex flex-col">
                    <div className="flex justify-between items-center mb-4 border-b border-tea-brown pb-2">
                        <h3 className="text-xl font-bold text-tea-brown flex items-center gap-2">
                            <Icon name="keyboard" className="inline"/> 第三關：課文打字
                        </h3>
                        <div className="flex items-center gap-4">
                            <span className="text-vermilion text-lg font-mono">{Math.floor(timeLeft/60)}:{(timeLeft%60).toString().padStart(2,'0')}</span>
                            <button onClick={onAbandon} className="bg-white border border-red-200 px-3 py-1 rounded-full text-red-500 hover:bg-red-500 hover:text-white transition text-sm font-bold flex items-center gap-1 cursor-pointer shadow-sm">
                                <Icon name="log-out" size={14}/> 放棄
                            </button>
                        </div>
                    </div>
                    
                    <div className="bg-amber-50 p-4 rounded mb-4 text-center border-2 border-dashed border-amber-200">
                        <h4 className="font-bold text-lg text-amber-800 mb-1">【默寫挑戰】</h4>
                        <p className="text-stone-600">請在下方對話框中，憑記憶默打出課文<span className="font-bold text-ink-black">第二段（夏蚊成雷...）</span>全文。</p>
                        <p className="text-xs text-gray-400 mt-1">＊注意：需包含正確標點符號。</p>
                    </div>

                    <textarea 
                        className="w-full h-40 p-4 border-2 border-stone-300 rounded focus:border-tea-brown focus:outline-none text-lg font-serif flex-1"
                        placeholder="請在此輸入：夏蚊成雷，私擬作群鶴舞空......"
                        value={input}
                        onChange={(e) => setInput(e.target.value)}
                        disabled={isFinished}
                    ></textarea>

                    <div className="text-right mt-2 text-sm text-gray-500">
                        字數：{input.length} / {targetText.length}
                    </div>

                    <button onClick={handleSubmit} className="w-full mt-4 btn-classical py-3 text-lg">
                        提交答案
                    </button>
                </div>
            );
        };

        // --- 最終挑戰 (修正：鎖定機制) ---
        const FinalQuiz = ({ onFinish, onAbandon, hasPenalty }) => {
            const [questions, setQuestions] = useState([]);
            const [idx, setIdx] = useState(0);
            const [userAnswers, setUserAnswers] = useState([]);
            const [showPenalty, setShowPenalty] = useState(hasPenalty);
            const [isLocked, setIsLocked] = useState(false);

            useEffect(() => {
                setQuestions(getRandomItems(POOL_LEVEL4, 10));
            }, []);

            if (showPenalty) {
                return <PenaltyNotice onConfirm={() => setShowPenalty(false)} />;
            }

            if (!questions || questions.length === 0) return <div className="p-8 text-center text-gray-500">載入考卷中...</div>;

            const handleAns = (idxOpt) => {
                if (isLocked) return;
                setIsLocked(true);

                const q = questions[idx];
                const isCorrect = idxOpt === q.ans;
                const record = { 
                    q: q.q, 
                    userAns: q.options[idxOpt], 
                    correctAns: q.options[q.ans], 
                    isCorrect, 
                    hint: q.hint 
                };
                const newAns = [...userAnswers, record];
                setUserAnswers(newAns);

                if (isCorrect) playSound('correct');
                else playSound('wrong');

                if (idx + 1 < questions.length) {
                    setTimeout(() => {
                        setIdx(idx + 1);
                        setIsLocked(false);
                    }, 500);
                } else {
                    setTimeout(() => {
                        const correctCount = newAns.filter(a => a.isCorrect).length;
                        const score = (correctCount / 10) * 100;
                        onFinish(score, newAns.filter(a => !a.isCorrect));
                    }, 500);
                }
            };

            const q = questions[idx];
            if (!q) return <div className="p-8 text-center text-gray-500">題目載入錯誤</div>;

            return (
                <div className="p-6 relative h-full flex flex-col">
                    <div className="flex justify-between items-center mb-6 border-b border-tea-brown pb-2">
                        <span className="font-bold text-gray-500">第 {idx + 1} / 10 題</span>
                        <button onClick={onAbandon} className="bg-white border border-red-200 px-3 py-1 rounded-full text-red-500 hover:bg-red-500 hover:text-white transition text-sm font-bold flex items-center gap-1 cursor-pointer shadow-sm">
                            <Icon name="log-out" size={14}/> 放棄
                        </button>
                    </div>
                    
                    <div className="bg-white p-6 rounded-xl shadow-md mb-6 border-l-8 border-bamboo-green min-h-[120px] flex items-center justify-center">
                        <p className="text-xl font-bold text-ink-black text-center">{q.q}</p>
                    </div>
                    <div className="grid gap-3">
                        {q.options.map((opt, i) => (
                            <button 
                                key={i} 
                                onClick={() => handleAns(i)} 
                                disabled={isLocked}
                                className={`text-left p-4 rounded-lg border-2 transition-all font-bold text-gray-700 bg-white border-stone-200 ${isLocked ? 'cursor-not-allowed bg-gray-50' : 'hover:bg-orange-50'}`}
                            >
                                {opt}
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        // --- 入學登記 ---
        const Onboarding = ({ user, setUser, onStart }) => (
            <div className="max-w-md mx-auto p-8 bg-white rounded-xl shadow-2xl border-4 border-double border-tea-brown mt-10 animate-float">
                <h1 className="text-3xl font-bold text-center mb-6 text-ink-black tracking-widest">私塾入學登記</h1>
                <div className="flex flex-col items-center mb-6">
                    <img src={TEACHER_CONFIG.npcImage} className="w-32 h-40 object-contain mb-2 drop-shadow-md rounded" alt="老夫子" />
                    <div className="bg-stone-100 p-3 rounded-lg text-sm text-gray-700 italic border-l-4 border-tea-brown">
                        「老夫乃今日講學之夫子。欲入此門，先報上名來。」
                        <br/>
                        <span className="text-xs text-gray-500 mt-1 block">(若為夫子查榜，請於姓名處填寫 teacher)</span>
                    </div>
                </div>
                
                <div className="space-y-3">
                    <div className="grid grid-cols-2 gap-2">
                        <input type="text" placeholder="班級 (例:701)" value={user.classNo} 
                            onChange={(e) => setUser({...user, classNo: e.target.value})}
                            className="w-full p-3 border-2 border-stone-300 rounded-lg text-center focus:border-tea-brown focus:outline-none" />
                        
                        <input type="text" placeholder="座號 (例:05)" value={user.seatNo} 
                            onChange={(e) => setUser({...user, seatNo: e.target.value})}
                            className="w-full p-3 border-2 border-stone-300 rounded-lg text-center focus:border-tea-brown focus:outline-none" />
                    </div>
                    
                    <input type="text" placeholder="姓名" value={user.name} 
                        onChange={(e) => setUser({...user, name: e.target.value})}
                        className="w-full p-3 border-2 border-stone-300 rounded-lg text-center text-lg focus:border-tea-brown focus:outline-none" />
                </div>

                <button onClick={onStart} className="w-full btn-classical justify-center text-xl py-3 mt-6">
                    {user.name.toLowerCase() === 'teacher' ? '進入教師介面' : '開始上課'} <Icon name="arrow-right" />
                </button>
            </div>
        );

        // --- 教師後台 ---
        const TeacherDashboard = ({ onBack }) => {
            const [inputCode, setInputCode] = useState("");
            const [result, setResult] = useState(null);
            const [error, setError] = useState("");

            const handleParse = () => {
                try {
                    const match = inputCode.match(/\[驗證碼:\s*([A-Za-z0-9+/=]+)\]/);
                    if (!match || !match[1]) throw new Error("格式錯誤，找不到驗證碼");
                    
                    const rawString = decodeURIComponent(escape(atob(match[1])));
                    const parts = rawString.split('_');

                    if (parts.length < 4) throw new Error("資料損毀");
                    
                    const classNo = parts[0];
                    const seatNo = parts[1];
                    const score = parseInt(parts[parts.length - 1]);
                    const name = parts.slice(2, parts.length - 1).join('_');
                    
                    if (isNaN(score)) throw new Error("分數無效");

                    setResult({ classNo, seatNo, name, finalScore: score });
                    setError("");
                    playSound('correct');
                } catch (err) {
                    setError("驗證失敗：代碼無效 (" + err.message + ")");
                    setResult(null);
                    playSound('wrong');
                }
            };

            return (
                <div className="max-w-2xl mx-auto p-6 animate-fadeIn">
                    <div className="bg-white rounded-xl shadow-2xl border-4 border-tea-brown p-6 relative">
                        <button onClick={onBack} className="absolute top-4 left-4 text-gray-500 hover:text-tea-brown flex items-center gap-1 cursor-pointer">
                            <Icon name="arrow-left" size={16}/> 返回
                        </button>
                        
                        <h2 className="text-2xl font-bold text-center mb-6 text-ink-black mt-4">夫子閱卷室</h2>
                        
                        <div className="mb-6">
                            <label className="block text-sm font-bold mb-2 text-gray-700">請貼上學生繳交的成績驗證碼：</label>
                            <input 
                                type="text"
                                value={inputCode}
                                onChange={(e) => setInputCode(e.target.value)}
                                className="w-full p-4 border-2 border-stone-300 rounded-lg text-lg font-mono focus:border-tea-brown focus:outline-none text-center"
                                placeholder="[驗證碼: ...]"
                            />
                            <button onClick={handleParse} className="w-full mt-3 btn-classical justify-center py-3 bg-bamboo-green hover:bg-green-700">
                                <Icon name="check-circle" /> 驗證成績
                            </button>
                        </div>

                        {error && (
                            <div className="p-4 bg-red-100 text-red-700 rounded-lg mb-4 text-center border border-red-300">
                                {error}
                            </div>
                        )}

                        {result && (
                            <div className="bg-stone-50 p-6 rounded-xl border-2 border-stone-300 animate-fadeIn text-center">
                                <div className="text-gray-500 mb-2">驗證成功</div>
                                <h3 className="text-2xl font-bold text-ink-black mb-2">
                                    {result.classNo} 班 {result.seatNo} 號 - {result.name}
                                </h3>
                                <div className="text-4xl font-black text-ink-black mb-2">
                                    最終成績：<span className="text-vermilion">{result.finalScore}</span> 分
                                </div>
                            </div>
                        )}
                    </div>
                </div>
            );
        };

        // --- 主程式 ---
        const App = () => {
            const [scene, setScene] = useState('onboarding'); 
            const [user, setUser] = useState({ classNo: '', seatNo: '', name: '' });
            const [customImage, setCustomImage] = useState(null);
            const [progress, setProgress] = useState({
                1: { done: false, score: 0, penalty: false },
                2: { done: false, score: 0, penalty: false },
                3: { done: false, score: 0, penalty: false },
                4: { done: false, score: 0, penalty: false }
            });

            const [showResultModal, setShowResultModal] = useState(false);
            const [showRulesModal, setShowRulesModal] = useState(false);
            const [showAbandonModal, setShowAbandonModal] = useState(false);
            const [showProfileConfirm, setShowProfileConfirm] = useState(false);
            const [currentAbandonLvl, setCurrentAbandonLvl] = useState(null);
            const [modalData, setModalData] = useState({ title: '', score: 0, wrongList: [] });

            useEffect(() => { if (window.lucide) window.lucide.createIcons(); }, [scene, showResultModal, showRulesModal, showAbandonModal, showProfileConfirm]);

            const startLobby = () => {
                 if (user.name.toLowerCase() === 'teacher') {
                     playSound('click');
                     setScene('teacher');
                     return;
                 }

                 if(user.classNo && user.seatNo && user.name.trim()) { 
                     playSound('click'); 
                     setScene('lobby'); 
                     setShowRulesModal(true); 
                 } else { 
                     alert("請完整填寫班級、座號與姓名"); 
                 }
            };

            const handleLevelFinish = (lvl, rawScore, wrongList) => {
                let finalScore = Math.round(rawScore);
                let detailsMsg = "";
                
                if (progress[lvl].penalty) {
                    finalScore = Math.max(0, finalScore - 10);
                    detailsMsg = "(已扣除懲罰 10 分)";
                }

                let title = "";
                if (lvl === 1) title = "第一關：形音義辨析" + detailsMsg;
                if (lvl === 2) title = "第二關：字義偵探" + detailsMsg;
                if (lvl === 3) title = "第三關：課文打字" + detailsMsg;
                if (lvl === 4) title = "狀元試" + detailsMsg;

                setModalData({ title, score: finalScore, wrongList });
                setProgress(prev => ({ ...prev, [lvl]: { ...prev[lvl], done: true, score: finalScore } }));
                setShowResultModal(true);
            };

            const triggerAbandon = (lvl) => {
                setCurrentAbandonLvl(lvl);
                setShowAbandonModal(true);
            };

            const confirmAbandon = () => {
                if (currentAbandonLvl) {
                    setProgress(prev => ({ 
                        ...prev, 
                        [currentAbandonLvl]: { ...prev[currentAbandonLvl], penalty: true } 
                    }));
                    setShowAbandonModal(false);
                    setScene('lobby');
                }
            };

            const closeResultModal = () => {
                setShowResultModal(false);
                if (modalData.title.includes("狀元試")) {
                    setShowProfileConfirm(true);
                } else {
                    setScene('lobby');
                }
            };
            
            const handleProfileConfirm = () => {
                setShowProfileConfirm(false);
                setScene('result');
            };

            const getAvgScore = () => Math.round((progress[1].score + progress[2].score + progress[3].score) / 3);
            const canUnlockFinal = () => progress[1].done && progress[2].done && progress[3].done && getAvgScore() >= 80;

            const generateReport = () => {
                const score = progress[4].score;
                const rawString = `${user.classNo}_${user.seatNo}_${user.name}_${score}`;
                const code = btoa(unescape(encodeURIComponent(rawString)));
                const formattedCode = `[驗證碼: ${code}]`;

                const textarea = document.createElement("textarea");
                textarea.value = formattedCode;
                document.body.appendChild(textarea);
                textarea.select();
                try {
                    document.execCommand("copy");
                    alert(`成績驗證碼已複製！\n${formattedCode}\n請直接貼上繳交。`);
                } catch (err) {
                    alert(`驗證碼：${formattedCode}\n(複製失敗，請手動抄寫)`);
                }
                document.body.removeChild(textarea);
            };

            const GameWrapper = ({ children }) => (
                <div className="max-w-3xl mx-auto pt-10 px-4 animate-fadeIn">
                    <div className="bg-white rounded-2xl shadow-xl min-h-[500px] border border-stone-200 relative overflow-hidden ink-border">
                        {children}
                    </div>
                </div>
            );

            const Lobby = () => (
                <div className="max-w-4xl mx-auto p-4 animate-fadeIn">
                    <header className="flex justify-between items-center mb-8 bg-white p-4 rounded-lg shadow-sm border border-stone-200">
                        <div>
                            <h1 className="text-2xl font-bold text-ink-black">兒時記趣</h1>
                            <span className="text-sm font-normal text-gray-600 block mt-1">
                                {user.classNo} 班 {user.seatNo} 號 - {user.name}
                            </span>
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="text-right text-sm">
                                <p>平均成績：<span className="font-bold text-vermilion text-lg">{getAvgScore()}</span> 分</p>
                                <p className="text-xs text-gray-400">目標：80分以上解鎖「最終挑戰」</p>
                            </div>
                            <button onClick={() => { if(confirm("確定要登出並回到首頁嗎？進度可能會遺失。")) setScene('onboarding'); }} className="ml-2 p-2 rounded-full hover:bg-stone-100 text-stone-500 transition" title="回首頁/登出">
                                <Icon name="home" size={20} />
                            </button>
                        </div>
                    </header>

                    <div className="grid md:grid-cols-3 gap-6">
                        <div className="md:col-span-1">
                            <div className="bg-white p-6 rounded-xl shadow-lg border-4 border-stone-800 relative overflow-hidden text-left">
                                <h2 className="text-2xl font-bold mb-4 font-serif text-stone-800 border-b-2 border-stone-200 pb-2">沈三白</h2>
                                <div className="flex flex-col gap-3">
                                    <div className="w-full h-40 bg-stone-100 rounded border-2 border-stone-200 mb-2 overflow-hidden">
                                         {customImage ? <img src={customImage} className="w-full h-full object-cover" /> : <img src={TEACHER_CONFIG.shenFuImage} className="w-full h-full object-cover opacity-90" alt="沈復" />}
                                    </div>
                                    <div className="text-sm text-stone-700 space-y-2">
                                        <p><span className="font-bold text-tea-brown">字號：</span>字三白，號梅逸</p>
                                        <p><span className="font-bold text-tea-brown">生平：</span>清代蘇州人，工詩善畫，情感真摯。</p>
                                        <p><span className="font-bold text-tea-brown">眷屬：</span>妻 陳芸</p>
                                        <p><span className="font-bold text-tea-brown">著作：</span>《浮生六記》</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div className="md:col-span-2 grid gap-4">
                            <LevelCard icon="feather" title="第一關：形音義辨析" desc="" score={progress[1].score} done={progress[1].done} penalty={progress[1].penalty} onClick={() => setScene('level1')} />
                            <LevelCard icon="search" title="第二關：字義偵探" desc="" score={progress[2].score} done={progress[2].done} penalty={progress[2].penalty} onClick={() => setScene('level2')} />
                            <LevelCard icon="keyboard" title="第三關：課文打字" desc="" score={progress[3].score} done={progress[3].done} penalty={progress[3].penalty} onClick={() => setScene('level3')} />
                            
                            <div className="mt-4 border-t-2 border-dashed border-stone-300 pt-4">
                                <button 
                                    onClick={() => canUnlockFinal() ? setScene('level4') : alert("請先完成前三關且平均分數達80分！")}
                                    disabled={!canUnlockFinal()}
                                    className={`w-full p-6 rounded-xl shadow-lg transition-all flex items-center justify-between
                                        ${canUnlockFinal() ? 'bg-gradient-to-r from-tea-brown to-stone-700 text-white hover:shadow-2xl cursor-pointer transform hover:-translate-y-1' : 'bg-gray-200 text-gray-400 cursor-not-allowed grayscale'}
                                    `}
                                >
                                    <div className="text-left">
                                        <h3 className="text-2xl font-bold mb-1 flex items-center gap-2"><Icon name={canUnlockFinal() ? "lock-open" : "lock"} /> 最終挑戰：狀元試</h3>
                                        <p className="text-sm opacity-80">{canUnlockFinal() ? "點擊開始" : "解鎖條件：三關平均 > 80分"}</p>
                                    </div>
                                    <Icon name="arrow-right" size={32} />
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            );

            return (
                <div className="pb-10">
                    {showRulesModal && <RulesModal onConfirm={() => setShowRulesModal(false)} />}
                    {showResultModal && <LevelResultModal {...modalData} onConfirm={closeResultModal} />}
                    {showAbandonModal && <AbandonModal onConfirm={confirmAbandon} onCancel={() => setShowAbandonModal(false)} />}
                    {showProfileConfirm && <ProfileConfirmModal user={user} setUser={setUser} onConfirm={handleProfileConfirm} />}

                    {scene === 'onboarding' && <Onboarding user={user} setUser={setUser} onStart={startLobby} />}
                    {scene === 'teacher' && <TeacherDashboard onBack={() => setScene('onboarding')} />}
                    {scene === 'lobby' && <Lobby />}
                    {scene === 'level1' && <GameWrapper><Level1_Words onFinish={(s, w) => handleLevelFinish(1, s, w)} onAbandon={() => triggerAbandon(1)} hasPenalty={progress[1].penalty} /></GameWrapper>}
                    {scene === 'level2' && <GameWrapper><Level2_Investigator onFinish={(s, w) => handleLevelFinish(2, s, w)} onAbandon={() => triggerAbandon(2)} hasPenalty={progress[2].penalty} /></GameWrapper>}
                    {scene === 'level3' && <GameWrapper><Level3_Typing onFinish={(s, w) => handleLevelFinish(3, s, w)} onAbandon={() => triggerAbandon(3)} hasPenalty={progress[3].penalty} /></GameWrapper>}
                    {scene === 'level4' && <GameWrapper><FinalQuiz onFinish={(s, w) => handleLevelFinish(4, s, w)} onAbandon={() => triggerAbandon(4)} hasPenalty={progress[4].penalty} /></GameWrapper>}
                    
                    {scene === 'result' && (
                        <div className="max-w-xl mx-auto p-8 pt-20 text-center animate-fadeIn">
                            <div className="bg-white p-8 rounded-3xl shadow-2xl border-4 border-accent-gold relative">
                                <Icon name="award" size={64} className="text-accent-gold mx-auto mb-4" />
                                <h2 className="text-2xl font-bold mb-4 text-ink-black">恭喜完成學業！</h2>
                                <div className="text-6xl font-black text-tea-brown mb-2">{progress[4].score}</div>
                                <p className="text-gray-500 mb-6">最終測驗分數</p>
                                <p className="text-sm text-gray-400 mb-2">考生：{user.classNo}班 {user.seatNo}號 {user.name}</p>
                                <button onClick={generateReport} className="w-full btn-classical justify-center text-lg py-3 mb-3 bg-bamboo-green hover:bg-green-700">
                                    <Icon name="copy" /> 複製成績驗證碼 (繳交作業)
                                </button>
                                <button onClick={() => window.location.reload()} className="w-full btn-classical justify-center text-lg py-3 bg-stone-600 hover:bg-stone-700">重新開始</button>
                            </div>
                        </div>
                    )}
                </div>
            );
        };

        const LevelCard = ({ icon, title, desc, score, done, penalty, onClick }) => (
            <button onClick={() => { playSound('click'); onClick(); }} className="w-full bg-white p-4 rounded-xl border border-stone-200 shadow-sm hover:border-tea-brown hover:shadow-md transition flex items-center justify-between group">
                <div className="flex items-center gap-4">
                    <div className={`p-3 rounded-full ${done ? 'bg-green-100 text-green-700' : 'bg-stone-100 text-stone-500 group-hover:bg-orange-100 group-hover:text-tea-brown'}`}>
                        <Icon name={icon} />
                    </div>
                    <div className="text-left">
                        <h4 className="font-bold text-lg text-ink-black flex items-center gap-2">
                            {title}
                            {penalty && <span className="text-xs text-red-500 bg-red-100 px-1 rounded">懲罰中</span>}
                        </h4>
                        <p className="text-xs text-gray-500">{desc}</p>
                    </div>
                </div>
                {done ? (
                    <div className="text-right">
                        <span className="text-2xl font-bold text-tea-brown">{score}</span>
                        <span className="text-xs text-gray-400 block">分</span>
                    </div>
                ) : <span className="text-xs bg-gray-100 px-2 py-1 rounded text-gray-500">未完成</span>}
            </button>
        );

        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>
